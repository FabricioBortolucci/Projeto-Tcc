<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title th:text="'Cancelar O.S. #' + ${os?.id ?: ''} + ' - Oficina'">Cancelar Ordem de Serviço</title>
    <link rel="stylesheet" type="text/css" media="all" th:href="@{/css/bootstrap.min.css}"/>
    <link rel="stylesheet" type="text/css" media="all" th:href="@{/images/bootstrap-icons.css}"/>
    <style>
        body {
            background-color: #f8f9fa;
        }

        .details-dl dt {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        @media (min-width: 576px) {
            .details-dl dt {
                margin-bottom: 0;
            }
        }

        .details-dl dd {
            margin-bottom: 0.75rem;
        }

        .table th, .table td {
            vertical-align: middle;
            text-align: center;
        }

        .table-dark .badge.bg-light {
            color: #000 !important;
        }

        .table td.text-start-md, .table th.text-start-md {
            text-align: center;
        }

        @media (min-width: 768px) {
            .table td.text-start-md, .table th.text-start-md {
                text-align: left;
            }
        }

        .tab-content > .tab-pane {
            padding-top: 1.5rem;
        }

        .badge.status-aberta {
            background-color: var(--bs-info-bg-subtle);
            color: var(--bs-info-text-emphasis);
            border: 1px solid var(--bs-info-border-subtle);
        }

        .badge.status-finalizada {
            background-color: var(--bs-success-bg-subtle);
            color: var(--bs-success-text-emphasis);
            border: 1px solid var(--bs-success-border-subtle);
        }

        .badge.status-cancelada {
            background-color: var(--bs-danger-bg-subtle);
            color: var(--bs-danger-text-emphasis);
            border: 1px solid var(--bs-danger-border-subtle);
        }
    </style>
</head>
<body>
<div class="d-flex">
    <div th:insert="~{fragments/sidebar}"></div>
    <main class="main-content-옆-sidebar-fixed d-flex flex-column w-100 min-vh-100 p-3 p-md-4 overflow-auto gap-4">

        <div>
            <h1 class="h3" th:text="'Cancelar Ordem de Serviço' + (${os?.id} ? ' #' + ${os.id} : '')"></h1>
            <p class="lead">Revise os dados da O.S. e preencha as informações de cancelamento abaixo.</p>
        </div>

        <div th:if="${os != null}" th:object="${os}">
            <ul class="nav nav-pills mb-3" id="osCancelTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="cancel-detalhes-os-tab" data-bs-toggle="tab"
                            data-bs-target="#cancel-detalhes-os-pane" type="button">
                        <i class="bi bi-file-earmark-text-fill me-1"></i> Detalhes da O.S.
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="cancel-servicos-tab" data-bs-toggle="tab"
                            data-bs-target="#cancel-servicos-pane"
                            type="button" role="tab" aria-controls="cancel-servicos-pane" aria-selected="false">
                        <i class="bi bi-tools me-1"></i> Serviços Prestados
                        <span th:if="${os.itensServico != null}"
                              class="badge rounded-pill bg-secondary ms-1"
                              th:text="${#lists.size(os.itensServico)}"></span>
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="cancel-pecas-tab" data-bs-toggle="tab"
                            data-bs-target="#cancel-pecas-pane"
                            type="button" role="tab" aria-controls="cancel-pecas-pane" aria-selected="false">
                        <i class="bi bi-box-seam me-1"></i> Peças Utilizadas
                        <span th:if="${os.pecasUsadas != null}"
                              class="badge rounded-pill bg-secondary ms-1"
                              th:text="${#lists.size(os.pecasUsadas)}"></span>
                    </button>
                </li>
            </ul>

            <div class="tab-content" id="osCancelTabContent">
                <div class="tab-pane fade show active" id="cancel-detalhes-os-pane" role="tabpanel"
                     aria-labelledby="cancel-detalhes-os-tab">
                    <div class="card shadow-sm">
                        <div class="card-header bg-light py-3">
                            <h5 class="mb-0 fw-semibold">Informações Gerais</h5>
                        </div>
                        <div class="card-body p-4">
                            <dl class="row details-dl">
                                <dt class="col-sm-3">Nº da O.S.:</dt>
                                <dd class="col-sm-9" th:text="*{id ?: 'N/A'}"></dd>
                                <dt class="col-sm-3">Cliente:</dt>
                                <dd class="col-sm-9" th:text="*{cliente?.pesNome ?: 'N/A'}"></dd>
                                <dt class="col-sm-3">Status Atual:</dt>
                                <dd class="col-sm-9" th:text="*{status?.descricao ?: status}"></dd>
                                <dt class="col-sm-3">Observações:</dt>
                                <dd class="col-sm-9">
                                    <p th:if="*{observacao != null and !observacao.isEmpty()}" th:text="*{observacao}"
                                       class="mb-0"></p>
                                    <p th:if="*{observacao == null or observacao.isEmpty()}"
                                       class="text-muted fst-italic mb-0">Sem observações.</p>
                                </dd>
                                <dt class="col-sm-3">Plano de Pagamento:</dt>
                                <dd class="col-sm-9" th:text="*{planoPagamento.descricao}"></dd>
                                <dt class="col-sm-3">Tipo de Pagamento:</dt>
                                <dd class="col-sm-9" th:text="*{tipoPagamento.descricao}"></dd>
                                <dt class="col-sm-3">Quantidade de Parcelas:</dt>
                                <dd class="col-sm-9"
                                    th:text="*{quantParcelas + 'x de ' + #numbers.formatCurrency(valorTotal / quantParcelas)}"></dd>
                                <dt class="col-sm-3">Valor Total da O.S.:</dt>
                                <dd class="col-sm-9 fw-bold"
                                    th:text="*{valorTotal != null ? #numbers.formatCurrency(valorTotal) : 'R$ 0,00'}"></dd>
                            </dl>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="cancel-servicos-pane" role="tabpanel"
                     aria-labelledby="cancel-servicos-tab">
                    <h5 class="mb-3 fw-semibold">Revisar Serviços Registrados</h5>
                    <div th:if="${os.itensServico != null and not #lists.isEmpty(os.itensServico)}"
                         class="table-responsive">
                        <table class="table table-dark table-striped table-bordered table-sm">
                            <thead>
                            <tr>
                                <th class="text-start-md">Descrição</th>
                                <th class="text-end">Qtd.</th>
                                <th class="text-end">Vlr. Unit.</th>
                                <th class="text-end">Subtotal</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="item : ${os.itensServico}">
                                <td class="text-start-md" th:text="${item.servico?.descricao ?: 'N/A'}"></td>
                                <td class="text-end" th:text="${item.quantidade ?: 0}"></td>
                                <td class="text-end" th:text="${#numbers.formatCurrency(item.valorUnitario)}"></td>
                                <td class="text-end" th:text="${#numbers.formatCurrency(item.subTotal)}"></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div th:if="${os.itensServico == null or #lists.isEmpty(os.itensServico)}"
                         class="alert alert-light border">Nenhum serviço registrado nesta O.S.
                    </div>
                </div>

                <div class="tab-pane fade" id="cancel-pecas-pane" role="tabpanel" aria-labelledby="cancel-pecas-tab">
                    <h5 class="mb-3 fw-semibold">Revisar Peças/Produtos Utilizados</h5>
                    <div th:if="${os.pecasUsadas != null and not #lists.isEmpty(os.pecasUsadas)}"
                         class="table-responsive">
                        <table class="table table-dark table-striped table-bordered table-sm">
                            <thead>
                            <tr>
                                <th class="text-start-md">Produto</th>
                                <th class="text-end">Qtd.</th>
                                <th class="text-end">Vlr. Unit.</th>
                                <th class="text-end">Subtotal</th>
                            </tr>
                            </thead>
                            <tbody>
                            <tr th:each="item : ${os.pecasUsadas}">
                                <td class="text-start-md" th:text="${item.produto?.nome ?: 'N/A'}"></td>
                                <td class="text-end" th:text="${item.quantidade ?: 0}"></td>
                                <td class="text-end" th:text="${#numbers.formatCurrency(item.valorUnitario)}"></td>
                                <td class="text-end" th:text="${#numbers.formatCurrency(item.subTotal)}"></td>
                            </tr>
                            </tbody>
                        </table>
                    </div>
                    <div th:if="${os.pecasUsadas == null or #lists.isEmpty(os.pecasUsadas)}"
                         class="alert alert-light border">Nenhuma peça/produto registrado nesta O.S.
                    </div>
                </div>
            </div>

            <div class="card shadow-sm mt-4 border-danger">
                <div class="card-header bg-danger text-white py-3">
                    <h5 class="mb-0 fw-semibold"><i class="bi bi-exclamation-octagon-fill me-2"></i>Ação de Cancelamento
                    </h5>
                </div>
                <div class="card-body p-4">
                    <form id="formConfirmarCancelamento"
                          th:action="@{/ordem-servico/cancelar-confirmado}" method="post">
                        <div th:if="${os.pecasUsadas != null and not #lists.isEmpty(os.pecasUsadas)}">
                            <fieldset class="mb-3">
                                <legend class="col-form-label pt-0 fs-6 fw-semibold">Ação Financeira para o Cliente:
                                </legend>
                                <p class="small text-muted">Escolha como lidar com os valores já pagos (se houver).</p>
                                <div class="d-flex flex-wrap gap-3">
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input"
                                               type="radio" name="acaoFinanceira"
                                               id="radioCredito"
                                               value="GERAR_CREDITO" checked>
                                        <label class="form-check-label" for="radioCredito">
                                            <i class="bi bi-wallet2"></i> Gerar Crédito
                                        </label>
                                    </div>
                                    <div class="form-check form-check-inline">
                                        <input class="form-check-input"
                                               type="radio" name="acaoFinanceira"
                                               id="radioReembolso"
                                               value="REEMBOLSAR">
                                        <label class="form-check-label" for="radioReembolso">
                                            <i class="bi bi-cash-coin"></i> Reembolsar Valor
                                        </label>
                                    </div>
                                </div>
                            </fieldset>
                            <h6 class="fw-semibold">Devolver Peças/Produtos Utilizadas ao Estoque?</h6>
                            <p class="small text-muted">Selecione as peças e produtos que devem retornar ao estoque.</p>
                            <div class="form-check mb-2">
                                <input class="form-check-input" type="checkbox" id="selecionarTodasPecas" checked>
                                <label class="form-check-label" for="selecionarTodasPecas"><strong>Selecionar Todas /
                                    Nenhuma</strong></label>
                            </div>
                            <div class="list-group list-group-flush border rounded-2"
                                 style="max-height: 200px; overflow-y: auto;">
                                <div th:each="item : *{pecasUsadas}" class="list-group-item py-2">
                                    <div class="form-check">
                                        <input class="form-check-input peca-checkbox" type="checkbox"
                                               name="pecasParaDevolver" th:value="${item.id}"
                                               th:id="'pecaCheck' + ${item.id}" checked>
                                        <label class="form-check-label" th:for="'pecaCheck' + ${item.id}"
                                               th:text="${item.quantidade + 'x ' + item.produto?.nome}"></label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="mt-3">
                            <label for="motivoCancelamento" class="form-label">Motivo do Cancelamento
                                (Obrigatório):</label>
                            <textarea class="form-control" id="motivoCancelamento" name="motivoCancelamento"
                                      th:field="*{observacaoCancelamento}" rows="3"
                                      placeholder="Descreva o motivo do cancelamento..." required></textarea>
                        </div>

                        <div class="pt-3 mt-4 border-top d-flex justify-content-end gap-2">
                            <a class="btn btn-outline-secondary" th:href="@{/ordem-servico/visualizar/{id}(id=*{id})}">
                                <i class="bi bi-x-circle me-1"></i> Voltar (Não Cancelar)
                            </a>
                            <button type="button" class="btn btn-danger" data-bs-toggle="modal"
                                    data-bs-target="#confirmacaoFinalModal">
                                <i class="bi bi-trash-fill me-1"></i> Cancelar Ordem de Serviço
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <div th:unless="${os != null}" class="alert alert-warning mt-4" role="alert">
            Ordem de Serviço não encontrada ou não disponível para cancelamento.
        </div>

        <div class="modal fade" id="confirmacaoFinalModal" tabindex="-1" aria-labelledby="confirmacaoFinalModalLabel"
             aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="confirmacaoFinalModalLabel"><i
                                class="bi bi-question-circle-fill text-danger me-2"></i>Confirmação Final</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
                    </div>
                    <div class="modal-body">
                        <p>Tem certeza que deseja cancelar permanentemente esta Ordem de Serviço?</p>
                        <p class="small text-danger">Esta ação é irreversível.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Não, voltar</button>
                        <button type="button" class="btn btn-danger" id="btnSubmitCancelamentoFinal">Sim, cancelar
                            O.S.
                        </button>
                    </div>
                </div>
            </div>
        </div>

    </main>
</div>

<script type="text/javascript" th:src="@{/js/bootstrap.bundle.min.js}"></script>
<script th:if="${os != null}">
    /*<![CDATA[*/
    document.addEventListener('DOMContentLoaded', function () {
        // Script para o checkbox "Selecionar Todas" na página
        const checkboxMestre = document.getElementById('selecionarTodasPecas');
        if (checkboxMestre) {
            const checkboxesPecas = document.querySelectorAll('.peca-checkbox');
            checkboxMestre.addEventListener('change', function () {
                checkboxesPecas.forEach(function (checkbox) {
                    checkbox.checked = checkboxMestre.checked;
                });
            });
        }

        // Script para conectar o botão de confirmação do modal ao formulário
        const btnConfirmarFinal = document.getElementById('btnSubmitCancelamentoFinal');
        if (btnConfirmarFinal) {
            const formCancelamento = document.getElementById('formConfirmarCancelamento');
            btnConfirmarFinal.addEventListener('click', function () {
                if (formCancelamento) {
                    formCancelamento.submit();
                }
            });
        }
    });
    /*]]>*/
</script>
</body>
</html>