<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Nova Compra - Oficina</title>
    <link rel="stylesheet" type="text/css" media="all" th:href="@{/css/bootstrap.min.css}"/>
    <link rel="stylesheet" type="text/css" media="all" th:href="@{/images/bootstrap-icons.css}"/>
    <link rel="stylesheet" type="text/css" media="all" th:href="@{/css/base.min.css}"/>
    <link rel="stylesheet" type="text/css" media="all" th:href="@{/css/choices.min.css}"/>
    <style>
        body {
            background-color: #f8f9fa;
        }

        .form-control:focus, .form-select:focus, .choices__input:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        .table th, .table td {
            vertical-align: middle;
            text-align: center;
        }

        .table-dark .badge.bg-light {
            color: #000 !important;
        }

        .action-button-wrapper .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }

        .action-button-wrapper .bi {
            vertical-align: text-bottom;
        }

        .tab-content > .tab-pane {
            padding-top: 1.5rem;
        }

        /* Estilo para Choices.js se alinhar melhor com Bootstrap */
        .choices {
            margin-bottom: 0;
        }

        .choices__inner {
            background-color: var(--bs-body-bg);
            border: var(--bs-border-width) solid var(--bs-border-color);
            border-radius: var(--bs-border-radius);
            font-size: 1rem;
            min-height: calc(1.5em + .75rem + 2px);
            padding: .375rem .75rem;
        }

        .choices.is-focused .choices__inner, .choices.is-open .choices__inner {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        .choices__list--dropdown {
            background-color: var(--bs-body-bg);
            border-color: var(--bs-border-color);
        }

        .choices__item--choice {
            padding: .5rem 1rem;
        }
    </style>
</head>
<body>
<div class="d-flex">
    <div th:insert="~{fragments/sidebar}"></div>
    <main class="d-flex flex-column w-100 min-vh-100 p-3 p-md-4 overflow-auto gap-3">
        <h1 class="h3 mb-0">Registrar Nova Compra</h1>

        <ul class="nav nav-pills mb-3" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="fornecedor-tab" data-bs-toggle="tab"
                        data-bs-target="#fornecedorTabPane"
                        type="button" role="tab" aria-controls="fornecedorTabPane" aria-selected="true">
                    <i class="bi bi-truck me-1"></i> Fornecedor e Produtos
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="fechamentoTab-tab" data-bs-toggle="tab" data-bs-target="#fechamentoTabPane"
                        type="button" role="tab" aria-controls="fechamentoTabPane" aria-selected="false">
                    <i class="bi bi-receipt-cutoff me-1"></i> Observações e Fechamento
                </button>
            </li>
        </ul>

        <form th:action="@{/compra/cadastrar}" method="post" th:object="${compra}" id="formPrincipalCompra">
            <input type="hidden" th:field="*{id}"/>

            <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade show active" id="fornecedorTabPane" role="tabpanel"
                     aria-labelledby="fornecedor-tab">
                    <div class="card shadow-sm">
                        <div class="card-header bg-light py-3">
                            <h5 class="mb-0 fw-semibold">Informações da Compra e Itens</h5>
                        </div>
                        <div class="card-body p-4">
                            <div class="row g-3">
                                <div class="col-md-7">
                                    <label class="form-label" for="fornecedorInput">Fornecedor:
                                        <span class="text-danger">*</span></label>
                                    <select class="form-select"
                                            id="fornecedorInput"
                                            th:field="*{fornecedor}" required>
                                        <option value="" selected>Selecione um fornecedor...</option>
                                        <option th:each="f : ${fornecedores_compra}"
                                                th:value="${f.id}"
                                                th:text="${f.pesNome}"></option>
                                    </select>
                                </div>
                                <div class="col-md-5">
                                    <label class="form-label" for="dataCompraInput">Data da Compra: <span
                                            class="text-danger">*</span></label>
                                    <input type="datetime-local" class="form-control" id="dataCompraInput"
                                           th:field="*{dataCompra}" required/>
                                </div>
                            </div>

                            <hr class="my-4">
                            <h6 class="mb-3 fw-semibold">Adicionar Produtos à Compra:</h6>
                            <div class="row g-3">
                                <div class="col-md-5">
                                    <label for="prodSelect" class="form-label">Produto:</label>
                                    <select id="prodSelect"
                                            class="form-select"
                                            name="prodId"
                                            th:hx-get="@{/compra/produto/buscar-precoProd}"
                                            hx-swap="outerHTML"
                                            hx-target="#valorProduto">
                                        <option value="" selected disabled>Selecione um produto...</option>
                                        <option th:each="prod : ${produtos}"
                                                th:value="${prod.id}"
                                                th:text="${prod.nome}"></option>
                                    </select>
                                </div>
                                <div id="valorProduto" class="col-md-3">
                                    <label class="form-label" for="valorCusto">Valor Custo (Un.):</label>
                                    <input type="text" class="form-control" id="valorCusto"
                                           th:field="*{valorUnitarioItens}"
                                           name="temp_valorCusto"
                                           placeholder="0,00">
                                </div>
                                <div class="col-md-2">
                                    <label class="form-label" for="quantidade">Quantidade:</label>
                                    <input type="number"
                                           th:field="*{quantItens}"
                                           class="form-control" id="quantidade" name="temp_quantidade" required>
                                </div>

                                <div class="col-md-2 d-flex align-items-center" style="margin-top: 1.5rem;">
                                    <button type="button" class="btn btn-primary w-100" id="btnAddProduto">
                                        <i class="bi bi-plus-circle-fill me-1"></i> Adicionar
                                    </button>
                                </div>

                            </div>

                            <div class="table-responsive mt-4">
                                <table id="prodTable"
                                       class="table table-dark table-striped table-hover table-bordered table-sm caption-top">
                                    <caption class="fs-6">Produtos Adicionados à Compra</caption>
                                    <thead>
                                    <tr>
                                        <th style="width:10%">Id Produto</th>
                                        <th>Nome</th>
                                        <th class="text-end">Preço Custo</th>
                                        <th class="text-end">Quantidade</th>
                                        <th class="text-end">Subtotal</th>
                                        <th class="text-center">Opções</th>
                                    </tr>
                                    </thead>
                                    <tbody id="corpoTabelaProdutosCompra">
                                    <!-- <tr id="linhaSemProdutosCompra" th:if="${#lists.isEmpty(compra.itens)}">
                                         <td colspan="6" class="text-muted p-3">Nenhum produto adicionado à compra.</td>
                                     </tr>-->
                                    </tbody>
                                    <tfoot>
                                    <tr>
                                        <td colspan="4" class="text-end fw-bold">Valor Total da Compra:</td>
                                        <td id="valorTotalCompraTfoot" class="text-end fw-bold">R$ 0,00</td>
                                        <td></td>
                                    </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="tab-pane fade" id="fechamentoTabPane" role="tabpanel" aria-labelledby="fechamentoTab-tab">
                    <div class="card shadow-sm">
                        <div class="card-header bg-light py-3">
                            <h5 class="mb-0 fw-semibold">Observações e Finalização</h5>
                        </div>
                        <div class="card-body p-4">
                            <div class="row g-3">
                                <div class="col-12">
                                    <label for="observacaoCompra" class="form-label">Observações Gerais da
                                        Compra:</label>
                                    <textarea class="form-control" id="observacaoCompra" th:field="*{observacao}"
                                              rows="4" style="resize: vertical;"></textarea>
                                </div>
                                <div class="col-12">
                                    <h4 class="text-end">Valor Total:
                                        <span id="valorTotalFinalCompra"
                                              th:text="${#numbers.formatCurrency(compra.valorTotal)}">R$ 0,00</span>
                                    </h4>
                                </div>
                            </div>

                            <div class="pt-3 mt-4 border-top d-flex justify-content-start gap-2">
                                <a class="btn btn-secondary" th:href="@{/compra}"> <i
                                        class="bi bi-x-circle me-1"></i>Cancelar
                                </a>
                                <button class="btn btn-success" type="submit">
                                    <i class="bi bi-check-lg me-1"></i>Salvar Compra
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </form>
    </main>
</div>

<script type="text/javascript" th:src="@{/js/choices.min.js}"></script>
<script type="text/javascript" th:src="@{/js/bootstrap.bundle.min.js}"></script>
<script src="//cdn.jsdelivr.net/npm/vanilla-masker@1.1.1/build/vanilla-masker.min.js"></script>
<script th:src="@{/js/htmx/htmx.min.js}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const valorCustoInput = document.getElementById('valorCusto');
        if (valorCustoInput) { // Verifica se o elemento existe
            VMasker(valorCustoInput).maskMoney({
                unit: 'R$', suffix: '', thousands: '.', decimal: ',', separator: ',',
                delimiter: '.', affixesStay: false, allowZero: true, allowNegative: true, precision: 2
            });
        }
        const selectF = document.getElementById('fornecedorInput');
        const choicesF = new Choices(selectF, {
            searchEnabled: true,
            itemSelectText: '',
            placeholder: true,
            searchPlaceholderValue: 'Buscar Fornecedor...'
        });
        const prodSelect = document.getElementById('prodSelect');
        const prodSelectChoices = new Choices(prodSelect, {
            searchEnabled: true,
            itemSelectText: '',
            placeholder: true,
            placeholderValue: 'Selecione um produto',
        });
    });
</script>

</body>
</html>